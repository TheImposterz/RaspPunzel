#!/bin/bash

# =============================================================================
# RaspPunzel - Installation Script v1.0
# Implant RedTeam portable pour Raspberry Pi
# =============================================================================

set -e

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration par d√©faut
DEFAULT_ADMIN_USER="admin"
DEFAULT_ADMIN_PASS="RedTeam2024!"
DEFAULT_WIFI_SSID="MAINTENANCE_WIFI"
DEFAULT_WIFI_PASS="SecureP@ss123!"
DEFAULT_AP_IP="192.168.10.1"
DEFAULT_WEB_PORT="8080"

# Variables globales pour la configuration
ADMIN_USER=""
ADMIN_PASS=""
WIFI_SSID=""
WIFI_PASS=""
AP_IP=""
WEB_PORT=""

# Fonction d'affichage am√©lior√©es
print_banner() {
    echo -e "${PURPLE}"
    cat << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                        üöÄ RaspPunzel üöÄ                      ‚ïë
‚ïë                                                              ‚ïë
‚ïë            Implant RedTeam portable pour Raspberry Pi       ‚ïë
‚ïë                     Installation v1.0                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
by @bl4ckarch
EOF
    echo -e "${NC}"
}

print_status() {
    echo -e "${BLUE}[üìã INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[‚úÖ SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[‚ö†Ô∏è  WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[‚ùå ERROR]${NC} $1"
}

print_step() {
    echo -e "${CYAN}[üîß STEP]${NC} $1"
}

# V√©rifications pr√©liminaires
check_prerequisites() {
    print_step "V√©rification des pr√©requis..."
    
    # V√©rification des privil√®ges root
    if [[ $EUID -ne 0 ]]; then
        print_error "Ce script doit √™tre ex√©cut√© en tant que root"
        echo "Utilisez: sudo $0"
        exit 1
    fi
    
    # V√©rification de la plateforme
    if ! grep -q "Raspberry Pi" /proc/cpuinfo 2>/dev/null; then
        print_warning "Syst√®me non d√©tect√© comme Raspberry Pi"
        read -p "Continuer quand m√™me? (y/N): " -n 1 -r
        echo
        [[ ! $REPLY =~ ^[Yy]$ ]] && exit 1
    fi
    
    # V√©rification de l'espace disque (minimum 4GB libre)
    local free_space=$(df / | awk 'NR==2 {print $4}')
    if [ $free_space -lt 4194304 ]; then  # 4GB en KB
        print_warning "Espace disque faible (moins de 4GB libre)"
        print_status "Espace libre: $(( free_space / 1024 / 1024 ))GB"
    fi
    
    # V√©rification de la connexion Internet
    if ! ping -c 1 8.8.8.8 >/dev/null 2>&1; then
        print_error "Connexion Internet requise pour l'installation"
        exit 1
    fi
    
    print_success "Pr√©requis valid√©s"
}

# Configuration interactive avec validation
configure_settings() {
    print_step "Configuration interactive de RaspPunzel"
    echo
    
    # Configuration utilisateur admin
    while true; do
        read -p "Nom d'utilisateur admin [$DEFAULT_ADMIN_USER]: " ADMIN_USER
        ADMIN_USER=${ADMIN_USER:-$DEFAULT_ADMIN_USER}
        if [[ $ADMIN_USER =~ ^[a-zA-Z0-9_-]{3,20}$ ]]; then
            break
        else
            print_error "Nom d'utilisateur invalide (3-20 caract√®res, lettres/chiffres/_/- uniquement)"
        fi
    done
    
    # Configuration mot de passe admin avec validation
    while true; do
        echo -n "Mot de passe admin (8+ caract√®res) [$DEFAULT_ADMIN_PASS]: "
        read -s ADMIN_PASS
        ADMIN_PASS=${ADMIN_PASS:-$DEFAULT_ADMIN_PASS}
        echo
        if [ ${#ADMIN_PASS} -ge 8 ]; then
            echo -n "Confirmer le mot de passe: "
            read -s ADMIN_PASS_CONFIRM
            echo
            if [ "$ADMIN_PASS" = "$ADMIN_PASS_CONFIRM" ]; then
                break
            else
                print_error "Les mots de passe ne correspondent pas"
            fi
        else
            print_error "Mot de passe trop court (minimum 8 caract√®res)"
        fi
    done
    
    # Configuration WiFi SSID
    while true; do
        read -p "SSID du WiFi cach√© [$DEFAULT_WIFI_SSID]: " WIFI_SSID
        WIFI_SSID=${WIFI_SSID:-$DEFAULT_WIFI_SSID}
        if [ ${#WIFI_SSID} -le 32 ] && [ ${#WIFI_SSID} -ge 1 ]; then
            break
        else
            print_error "SSID invalide (1-32 caract√®res)"
        fi
    done
    
    # Configuration mot de passe WiFi
    while true; do
        echo -n "Mot de passe WiFi (8+ caract√®res) [$DEFAULT_WIFI_PASS]: "
        read -s WIFI_PASS
        WIFI_PASS=${WIFI_PASS:-$DEFAULT_WIFI_PASS}
        echo
        if [ ${#WIFI_PASS} -ge 8 ] && [ ${#WIFI_PASS} -le 63 ]; then
            break
        else
            print_error "Mot de passe WiFi invalide (8-63 caract√®res)"
        fi
    done
    
    # Configuration IP avec validation
    while true; do
        read -p "IP du point d'acc√®s [$DEFAULT_AP_IP]: " AP_IP
        AP_IP=${AP_IP:-$DEFAULT_AP_IP}
        if [[ $AP_IP =~ ^192\.168\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
            break
        else
            print_error "IP invalide (format: 192.168.x.x)"
        fi
    done
    
    # Configuration port web
    while true; do
        read -p "Port interface web [$DEFAULT_WEB_PORT]: " WEB_PORT
        WEB_PORT=${WEB_PORT:-$DEFAULT_WEB_PORT}
        if [[ $WEB_PORT =~ ^[0-9]+$ ]] && [ $WEB_PORT -ge 1024 ] && [ $WEB_PORT -le 65535 ]; then
            break
        else
            print_error "Port invalide (1024-65535)"
        fi
    done
    
    echo
    print_success "Configuration enregistr√©e"
    
    # R√©sum√© de la configuration
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${YELLOW}üìã R√©sum√© de la configuration:${NC}"
    echo "   üë§ Utilisateur admin: $ADMIN_USER"
    echo "   üì° SSID WiFi: $WIFI_SSID (cach√©)"
    echo "   üåê IP point d'acc√®s: $AP_IP"
    echo "   üîå Port web: $WEB_PORT"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo
    
    read -p "Confirmer la configuration? (Y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        print_warning "Configuration annul√©e"
        exit 0
    fi
}

# Application de la configuration aux templates
apply_configuration() {
    print_step "Application de la configuration..."
    
    # Cr√©ation des r√©pertoires n√©cessaires
    mkdir -p /opt/rasppunzel-web
    mkdir -p /opt/rasppunzel-scripts
    mkdir -p /var/log/rasppunzel
    
    # Application de la configuration aux templates r√©seau
    if [ -f "config/network/hostapd.conf.template" ]; then
        sed "s/MAINTENANCE_WIFI/$WIFI_SSID/g; s/SecureP@ss123!/$WIFI_PASS/g" \
            config/network/hostapd.conf.template > /etc/hostapd/hostapd.conf
        print_success "Configuration hostapd appliqu√©e"
    fi
    
    if [ -f "config/network/dnsmasq.conf.template" ]; then
        sed "s/192\.168\.10\.1/$AP_IP/g" \
            config/network/dnsmasq.conf.template > /etc/dnsmasq.conf
        print_success "Configuration dnsmasq appliqu√©e"
    fi
    
    if [ -f "config/network/interfaces.template" ]; then
        sed "s/192\.168\.10\.1/$AP_IP/g" \
            config/network/interfaces.template > /etc/network/interfaces.new
        print_success "Configuration interfaces pr√©par√©e"
    fi
    
    # Configuration nginx
    if [ -f "config/services/nginx-rasppunzel.conf" ]; then
        sed "s/8080/$WEB_PORT/g" \
            config/services/nginx-rasppunzel.conf > /etc/nginx/sites-available/rasppunzel
        print_success "Configuration nginx appliqu√©e"
    fi
    
    print_success "Configuration appliqu√©e aux templates"
}

# Copie des fichiers de configuration
copy_configurations() {
    print_step "Copie des fichiers de configuration..."
    
    # Copie des scripts avec permissions
    if [ -d "scripts" ]; then
        cp -r scripts/* /opt/rasppunzel-scripts/
        chmod +x /opt/rasppunzel-scripts/*.sh
        print_success "Scripts copi√©s et rendus ex√©cutables"
    fi
    
    # Copie de l'interface web
    if [ -f "web/dashboard.html" ]; then
        cp web/dashboard.html /opt/rasppunzel-web/
        print_success "Interface web copi√©e"
    fi
    
    # Copie des services systemd
    if [ -f "config/systemd/rasppunzel-tower.service" ]; then
        cp config/systemd/rasppunzel-tower.service /etc/systemd/system/
        systemctl daemon-reload
        print_success "Service systemd install√©"
    fi
    
    if [ -f "config/systemd/rasppunzel-network.service" ]; then
        cp config/systemd/rasppunzel-network.service /etc/systemd/system/
        print_success "Service r√©seau systemd install√©"
    fi
}

# Configuration des services syst√®me
setup_services() {
    print_step "Configuration des services syst√®me..."
    
    # Service SSH avec configuration s√©curis√©e
    systemctl enable ssh
    
    # Application de la configuration SSH si disponible
    if [ -f "config/services/ssh-config.template" ]; then
        cp config/services/ssh-config.template /etc/ssh/sshd_config.rasppunzel
        print_status "Configuration SSH de r√©f√©rence cr√©√©e"
    fi
    
    # Configuration SSH de base
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
    
    # Cr√©ation de l'utilisateur admin
    if ! id "$ADMIN_USER" &>/dev/null; then
        useradd -m -s /bin/bash "$ADMIN_USER"
        echo "$ADMIN_USER:$ADMIN_PASS" | chpasswd
        usermod -aG sudo "$ADMIN_USER"
        
        # Cr√©ation du r√©pertoire SSH pour l'utilisateur
        mkdir -p /home/$ADMIN_USER/.ssh
        chmod 700 /home/$ADMIN_USER/.ssh
        chown $ADMIN_USER:$ADMIN_USER /home/$ADMIN_USER/.ssh
        
        print_success "Utilisateur '$ADMIN_USER' cr√©√© avec privil√®ges sudo"
    else
        print_warning "L'utilisateur '$ADMIN_USER' existe d√©j√†"
    fi
    
    # Configuration de l'auto-login console
    mkdir -p /etc/systemd/system/getty@tty1.service.d/
    cat > /etc/systemd/system/getty@tty1.service.d/autologin.conf << EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin $ADMIN_USER --noclear %I \$TERM
EOF
    
    # Configuration nginx
    if [ -f "/etc/nginx/sites-available/rasppunzel" ]; then
        ln -sf /etc/nginx/sites-available/rasppunzel /etc/nginx/sites-enabled/
        rm -f /etc/nginx/sites-enabled/default
        systemctl enable nginx
        print_success "Configuration nginx activ√©e"
    fi
    
    print_success "Services syst√®me configur√©s"
}

# Activation des services de d√©marrage automatique
setup_autostart() {
    print_step "Configuration du d√©marrage automatique..."
    
    # Activation des services systemd
    systemctl enable rasppunzel-tower.service 2>/dev/null || print_warning "Service rasppunzel-tower non trouv√©"
    systemctl enable rasppunzel-network.service 2>/dev/null || print_warning "Service rasppunzel-network non trouv√©"
    
    # Cr√©ation d'un service de fallback si les services principaux n'existent pas
    if [ ! -f "/etc/systemd/system/rasppunzel-tower.service" ]; then
        cat > /etc/systemd/system/rasppunzel-fallback.service << EOF
[Unit]
Description=RaspPunzel Fallback Service
After=network.target
Wants=network.target

[Service]
Type=oneshot
ExecStart=/opt/rasppunzel-scripts/start-services.sh
ExecStop=/opt/rasppunzel-scripts/stop-services.sh
RemainAfterExit=yes
User=root

[Install]
WantedBy=multi-user.target
EOF
        systemctl daemon-reload
        systemctl enable rasppunzel-fallback.service
        print_success "Service de fallback cr√©√© et activ√©"
    fi
    
    print_success "D√©marrage automatique configur√©"
}

# Cr√©ation d'un script de status system
create_status_script() {
    print_step "Cr√©ation des outils de diagnostic..."
    
    cat > /usr/local/bin/rasppunzel-status << 'EOF'
#!/bin/bash
# Script de status RaspPunzel

echo "üöÄ RaspPunzel Status Dashboard üöÄ"
echo "=================================="
echo
echo "üìä Services Status:"
systemctl is-active --quiet ssh && echo "  ‚úÖ SSH: Active" || echo "  ‚ùå SSH: Inactive"
systemctl is-active --quiet hostapd && echo "  ‚úÖ hostapd: Active" || echo "  ‚ùå hostapd: Inactive"
systemctl is-active --quiet dnsmasq && echo "  ‚úÖ dnsmasq: Active" || echo "  ‚ùå dnsmasq: Inactive"
systemctl is-active --quiet nginx && echo "  ‚úÖ nginx: Active" || echo "  ‚ùå nginx: Inactive"

echo
echo "üåê Network Status:"
ip addr show | grep "inet " | grep -v "127.0.0.1" | while read line; do
    echo "  üì° $line"
done

echo
echo "üíæ System Resources:"
echo "  üîã Uptime: $(uptime -p)"
echo "  üíΩ Disk Usage: $(df -h / | awk 'NR==2 {print $5 " used"}')"
echo "  üß† Memory: $(free -h | awk 'NR==2{printf "%.1fG/%.1fG (%.0f%%)\n", $3/1024, $2/1024, $3*100/$2}')"
echo "  üå°Ô∏è Temperature: $(vcgencmd measure_temp 2>/dev/null || echo "N/A")"

echo
echo "üì± Access Information:"
echo "  üåê Web Interface: http://$(hostname -I | awk '{print $1}'):8080"
echo "  üîê SSH: ssh admin@$(hostname -I | awk '{print $1}')"
EOF
    
    chmod +x /usr/local/bin/rasppunzel-status
    
    # Alias dans bashrc
    echo "alias rpstatus='rasppunzel-status'" >> /home/$ADMIN_USER/.bashrc 2>/dev/null || true
    
    print_success "Script de diagnostic cr√©√© (/usr/local/bin/rasppunzel-status)"
}

# Nettoyage et optimisation finale
cleanup_and_optimize() {
    print_step "Nettoyage et optimisation finale..."
    
    # Nettoyage APT
    apt-get autoremove -y -qq
    apt-get autoclean -qq
    
    # Optimisation des logs
    mkdir -p /var/log/rasppunzel
    touch /var/log/rasppunzel/access.log
    touch /var/log/rasppunzel/install.log
    
    # Log de l'installation
    echo "[$(date)] RaspPunzel installation completed successfully" >> /var/log/rasppunzel/install.log
    
    # Optimisation des permissions
    chown -R $ADMIN_USER:$ADMIN_USER /home/$ADMIN_USER 2>/dev/null || true
    chmod -R 755 /opt/rasppunzel-scripts
    chmod 644 /var/log/rasppunzel/*.log
    
    # Nettoyage des fichiers temporaires
    rm -rf /tmp/rasppunzel-* 2>/dev/null || true
    
    print_success "Nettoyage et optimisation termin√©s"
}

# Installation compl√®te avec gestion d'erreur
main() {
    # Gestion des erreurs
    trap 'print_error "Installation √©chou√©e √† la ligne $LINENO. Consultez /var/log/rasppunzel/install.log"' ERR
    
    clear
    print_banner
    
    print_status "D√©marrage de l'installation RaspPunzel v1.0"
    print_status "Temps estim√©: 10-15 minutes selon votre connexion Internet"
    echo
    
    # √âtapes d'installation
    check_prerequisites
    configure_settings
    apply_configuration
    
    # Ex√©cution des sous-scripts avec v√©rification
    print_step "Ex√©cution des scripts de configuration..."
    
    if [ -f "scripts/update-system.sh" ]; then
        print_status "Mise √† jour du syst√®me..."
        bash scripts/update-system.sh || print_warning "Mise √† jour syst√®me √©chou√©e (non critique)"
    fi
    
    if [ -f "scripts/install-tools.sh" ]; then
        print_status "Installation des outils de pentest..."
        bash scripts/install-tools.sh || print_warning "Installation d'outils √©chou√©e (non critique)"
    fi
    
    if [ -f "scripts/setup-network.sh" ]; then
        print_status "Configuration r√©seau..."
        bash scripts/setup-network.sh || print_error "Configuration r√©seau √©chou√©e (critique)"
    fi
    
    copy_configurations
    setup_services
    setup_autostart
    create_status_script
    cleanup_and_optimize
    
    # R√©sum√© final
    echo
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë                  ‚úÖ INSTALLATION R√âUSSIE ‚úÖ                   ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo
    print_success "RaspPunzel v1.0 install√© avec succ√®s!"
    print_warning "‚ö†Ô∏è  RED√âMARRAGE REQUIS pour finaliser l'installation"
    echo
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${YELLOW}üì± Informations d'acc√®s apr√®s red√©marrage:${NC}"
    echo
    echo "   üì° WiFi AP (cach√©): $WIFI_SSID"
    echo "   üîê Mot de passe WiFi: [CONFIGUR√â]"
    echo "   üåê IP du Pi: $AP_IP"
    echo "   üíª Interface Web: http://$AP_IP:$WEB_PORT"
    echo "   üîë SSH: ssh $ADMIN_USER@$AP_IP"
    echo
    echo -e "${YELLOW}üõ†Ô∏è  Commandes utiles:${NC}"
    echo "   rasppunzel-status  # Status du syst√®me"
    echo "   make start         # D√©marrer les services"
    echo "   make status        # Voir l'√©tat des services"
    echo
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo
    
    # Proposition de red√©marrage
    read -p "üîÑ Red√©marrer maintenant pour finaliser l'installation? (Y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        echo
        print_warning "N'oubliez pas de red√©marrer plus tard avec: sudo reboot"
        print_status "Installation termin√©e. Red√©marrage manuel requis."
    else
        echo
        print_status "Red√©marrage en cours..."
        sleep 2
        reboot
    fi
}

# Point d'entr√©e avec gestion des arguments
case "${1:-install}" in
    install|"")
        main "$@"
        ;;
    --help|-h)
        echo "RaspPunzel Installation Script v1.0"
        echo
        echo "Usage: $0 [options]"
        echo
        echo "Options:"
        echo "  install, (default)  Installation compl√®te interactive"
        echo "  --help, -h          Afficher cette aide"
        echo "  --version, -v       Afficher la version"
        echo
        ;;
    --version|-v)
        echo "RaspPunzel Installation Script v1.0"
        echo "Implant RedTeam portable pour Raspberry Pi"
        ;;
    *)
        print_error "Option inconnue: $1"
        echo "Utilisez: $0 --help pour voir les options disponibles"
        exit 1
        ;;
esac